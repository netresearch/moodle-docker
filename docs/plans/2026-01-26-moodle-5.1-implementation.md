# Moodle 5.1 Docker Stack Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement the complete Moodle 5.1 Docker stack with PHP-FPM + nginx architecture, runtime Moodle download, and env-based configuration.

**Architecture:** Separated PHP-FPM and nginx containers. Entrypoint downloads Moodle at runtime based on MOODLE_VERSION env var. Config.php generated from environment variables. Dedicated cron container with Ofelia scheduling.

**Tech Stack:** PHP 8.4 FPM Alpine, nginx 1.27 Alpine with brotli/HTTP3, MariaDB 11.8 LTS, Valkey 9 Alpine, Ofelia, Mailpit

---

## Phase 1: Moodle PHP-FPM Image

### Task 1.1: Create Moodle Dockerfile

**Files:**
- Create: `docker/moodle/Dockerfile.new`
- Reference: `docs/plans/2026-01-26-moodle-5.1-design.md` (Section 7)

**Step 1: Create the new Dockerfile**

```dockerfile
# Moodle 5.x Runtime Image
# PHP 8.4 FPM on Alpine

FROM php:8.4-fpm-alpine

LABEL maintainer="Netresearch <info@netresearch.de>"
LABEL description="Moodle 5.x PHP-FPM runtime"

# Build dependencies (removed after compile)
ARG BUILD_DEPS="autoconf g++ make libpng-dev libjpeg-turbo-dev freetype-dev \
    libxml2-dev icu-dev libzip-dev libsodium-dev oniguruma-dev \
    postgresql-dev openldap-dev bzip2-dev curl-dev"

# Runtime dependencies
ARG RUNTIME_DEPS="bash curl git unzip \
    libpng libjpeg-turbo freetype libxml2 icu-libs libzip libsodium \
    oniguruma postgresql-libs libldap libbz2 \
    fcgi"

# Install dependencies and PHP extensions
RUN apk add --no-cache $RUNTIME_DEPS $BUILD_DEPS \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-configure ldap \
    && docker-php-ext-install -j$(nproc) \
        mysqli pdo_mysql \
        pgsql pdo_pgsql \
        gd \
        xml soap \
        intl \
        mbstring \
        zip bz2 \
        bcmath \
        opcache \
        ldap \
        sodium \
        exif \
        sockets \
        pcntl \
    && pecl install redis igbinary apcu \
    && docker-php-ext-enable redis igbinary apcu \
    && apk del $BUILD_DEPS \
    && rm -rf /tmp/* /var/cache/apk/*

# PHP configuration for Moodle
RUN { \
    echo 'memory_limit = 256M'; \
    echo 'upload_max_filesize = 100M'; \
    echo 'post_max_size = 100M'; \
    echo 'max_execution_time = 300'; \
    echo 'max_input_vars = 5000'; \
    echo 'file_uploads = On'; \
    echo 'session.save_handler = files'; \
    echo 'display_errors = Off'; \
    echo 'log_errors = On'; \
} > /usr/local/etc/php/conf.d/moodle.ini

# OPcache configuration with JIT
RUN { \
    echo 'opcache.enable=1'; \
    echo 'opcache.memory_consumption=256'; \
    echo 'opcache.interned_strings_buffer=16'; \
    echo 'opcache.max_accelerated_files=20000'; \
    echo 'opcache.revalidate_freq=60'; \
    echo 'opcache.fast_shutdown=1'; \
    echo 'opcache.enable_cli=0'; \
    echo 'opcache.jit=1255'; \
    echo 'opcache.jit_buffer_size=128M'; \
} > /usr/local/etc/php/conf.d/opcache.ini

# PHP-FPM pool configuration
RUN { \
    echo '[www]'; \
    echo 'pm = dynamic'; \
    echo 'pm.max_children = 50'; \
    echo 'pm.start_servers = 5'; \
    echo 'pm.min_spare_servers = 5'; \
    echo 'pm.max_spare_servers = 35'; \
    echo 'pm.max_requests = 500'; \
    echo 'pm.status_path = /status'; \
    echo 'ping.path = /ping'; \
    echo 'ping.response = pong'; \
} > /usr/local/etc/php-fpm.d/zz-moodle.conf

# PHP-FPM healthcheck script
RUN echo '#!/bin/sh' > /usr/local/bin/php-fpm-healthcheck \
    && echo 'SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:9000 | grep -q pong' >> /usr/local/bin/php-fpm-healthcheck \
    && chmod +x /usr/local/bin/php-fpm-healthcheck

# Create directories
RUN mkdir -p /var/www/html /var/moodledata \
    && chown -R www-data:www-data /var/www/html /var/moodledata

# Copy entrypoint script
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

WORKDIR /var/www/html

EXPOSE 9000

ENTRYPOINT ["/entrypoint.sh"]
CMD ["php-fpm"]
```

**Step 2: Verify file was created**

Run: `ls -la docker/moodle/Dockerfile.new`
Expected: File exists with correct permissions

**Step 3: Commit**

```bash
git add docker/moodle/Dockerfile.new
git commit -S -m "feat(moodle): add PHP 8.4 FPM Dockerfile for Moodle 5.1"
```

---

### Task 1.2: Create Moodle Entrypoint Script

**Files:**
- Create: `docker/moodle/entrypoint.sh`

**Step 1: Create the entrypoint script**

```bash
#!/bin/bash
set -e

# =============================================================================
# Moodle 5.x Docker Entrypoint
# Downloads Moodle on first run, generates config.php from environment
# =============================================================================

# Configuration
MOODLE_VERSION="${MOODLE_VERSION:-5.1.2}"
INSTALL_DIR="/var/www/html"
VERSION_FILE="${INSTALL_DIR}/.moodle-version"
INSTALLED_VERSION=$(cat "$VERSION_FILE" 2>/dev/null || echo "none")

# Logging helper
log() {
    echo "[moodle-entrypoint] $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

# Skip bootstrap for cron container
if [ "${MOODLE_SKIP_BOOTSTRAP:-false}" = "true" ]; then
    log "MOODLE_SKIP_BOOTSTRAP=true, skipping bootstrap"
    exec "$@"
fi

# =============================================================================
# Moodle Download and Installation
# =============================================================================

backup_user_plugins() {
    log "Backing up user plugins..."
    mkdir -p /tmp/plugins_backup

    # Plugin directories that may contain user additions
    local plugin_types="mod local blocks theme auth enrol report question format"

    for ptype in $plugin_types; do
        local src_dir="$INSTALL_DIR/$ptype"
        if [ -d "$src_dir" ]; then
            mkdir -p "/tmp/plugins_backup/$ptype"
            # Copy all plugins (we'll filter core vs user later if needed)
            cp -r "$src_dir"/* "/tmp/plugins_backup/$ptype/" 2>/dev/null || true
        fi
    done

    log "Plugin backup complete"
}

restore_user_plugins() {
    log "Restoring user plugins..."

    local plugin_types="mod local blocks theme auth enrol report question format"

    for ptype in $plugin_types; do
        local backup_dir="/tmp/plugins_backup/$ptype"
        local dest_dir="$INSTALL_DIR/$ptype"

        if [ -d "$backup_dir" ]; then
            # Use cp -n to not overwrite existing (core) plugins
            cp -rn "$backup_dir"/* "$dest_dir/" 2>/dev/null || true
        fi
    done

    rm -rf /tmp/plugins_backup
    log "Plugin restore complete"
}

download_moodle() {
    local version="$1"

    # Extract major.minor for stable branch (e.g., 5.1.2 -> 501)
    local major=$(echo "$version" | cut -d. -f1)
    local minor=$(echo "$version" | cut -d. -f2)
    local stable_branch="${major}0${minor}"

    log "Downloading Moodle ${version} (stable${stable_branch})..."

    # Backup existing plugins if upgrading
    if [ -d "$INSTALL_DIR/lib" ]; then
        backup_user_plugins
    fi

    # Download Moodle
    local download_url="https://download.moodle.org/download.php/direct/stable${stable_branch}/moodle-${version}.tgz"
    log "Download URL: $download_url"

    # Download to temp and extract
    local temp_file="/tmp/moodle-${version}.tgz"
    curl -fSL "$download_url" -o "$temp_file"

    # Extract (strip the moodle-X.Y.Z directory)
    tar -xzf "$temp_file" -C "$INSTALL_DIR" --strip-components=1
    rm -f "$temp_file"

    # Restore user plugins if we had any
    if [ -d "/tmp/plugins_backup" ]; then
        restore_user_plugins
    fi

    # Mark installed version
    echo "$version" > "$VERSION_FILE"

    log "Moodle ${version} installed successfully"
}

# =============================================================================
# Config Generation
# =============================================================================

generate_config() {
    log "Generating config.php from environment..."

    # Determine SSL proxy setting (convert to PHP boolean)
    local ssl_proxy_php="false"
    if [ "${SSL_PROXY:-false}" = "true" ]; then
        ssl_proxy_php="true"
    fi

    cat > "${INSTALL_DIR}/config.php" <<EOFCONFIG
<?php
// Moodle configuration file - auto-generated by Docker entrypoint
// Do not edit directly - configure via environment variables

unset(\$CFG);
global \$CFG;
\$CFG = new stdClass();

// =============================================================================
// Database Settings
// =============================================================================
\$CFG->dbtype    = '${DB_TYPE:-mariadb}';
\$CFG->dblibrary = 'native';
\$CFG->dbhost    = '${DB_HOST:-database}';
\$CFG->dbname    = '${DB_NAME:-moodle}';
\$CFG->dbuser    = '${DB_USER:-moodle}';
\$CFG->dbpass    = '${DB_PASSWORD}';
\$CFG->prefix    = '${DB_PREFIX:-mdl_}';
\$CFG->dboptions = [
    'dbcollation' => 'utf8mb4_unicode_ci',
];

// =============================================================================
// Site Settings
// =============================================================================
\$CFG->wwwroot   = '${MOODLE_URL:-http://localhost}';
\$CFG->dataroot  = '/var/moodledata';
\$CFG->admin     = 'admin';
\$CFG->directorypermissions = 02775;

// =============================================================================
// Session Handling (Valkey/Redis)
// =============================================================================
\$CFG->session_handler_class = '\core\session\redis';
\$CFG->session_redis_host = '${VALKEY_HOST:-valkey}';
\$CFG->session_redis_port = ${VALKEY_PORT:-6379};
\$CFG->session_redis_auth = '${VALKEY_PASSWORD:-}';
\$CFG->session_redis_database = 0;
\$CFG->session_redis_prefix = 'mdl_sess_';
\$CFG->session_redis_acquire_lock_timeout = 120;
\$CFG->session_redis_lock_expire = 7200;

// =============================================================================
// Reverse Proxy Settings
// =============================================================================
\$CFG->reverseproxy = true;
\$CFG->sslproxy = ${ssl_proxy_php};

// =============================================================================
// Email Settings
// =============================================================================
\$CFG->smtphosts = '${SMTP_HOST:-mailpit}:${SMTP_PORT:-1025}';
\$CFG->noreplyaddress = '${SMTP_NOREPLY:-noreply@example.com}';

// =============================================================================
// Performance Settings
// =============================================================================
\$CFG->localcachedir = '/tmp/moodle_cache';

// =============================================================================
// Security Settings
// =============================================================================
\$CFG->passwordpolicy = true;
\$CFG->cronclionly = true;
\$CFG->cronremotepassword = '';

// =============================================================================
// Debug Settings (controlled by environment)
// =============================================================================
if (getenv('MOODLE_DEBUG') === 'true') {
    @error_reporting(E_ALL | E_STRICT);
    @ini_set('display_errors', '1');
    \$CFG->debug = (E_ALL | E_STRICT);
    \$CFG->debugdisplay = 1;
}

require_once(__DIR__ . '/lib/setup.php');
EOFCONFIG

    log "config.php generated"
}

# =============================================================================
# Permissions
# =============================================================================

fix_permissions() {
    log "Fixing permissions..."

    # Ensure moodledata is writable
    if [ -d /var/moodledata ]; then
        chown -R www-data:www-data /var/moodledata 2>/dev/null || true
        chmod -R 0775 /var/moodledata 2>/dev/null || true
    fi

    # Ensure code directory is writable for plugin installs
    if [ -d "$INSTALL_DIR" ]; then
        chown -R www-data:www-data "$INSTALL_DIR" 2>/dev/null || true
    fi

    log "Permissions fixed"
}

# =============================================================================
# Main
# =============================================================================

log "Starting Moodle entrypoint..."
log "MOODLE_VERSION=$MOODLE_VERSION"
log "INSTALLED_VERSION=$INSTALLED_VERSION"

# Download/upgrade Moodle if needed
if [ "$INSTALLED_VERSION" != "$MOODLE_VERSION" ]; then
    download_moodle "$MOODLE_VERSION"
fi

# Always regenerate config (environment may have changed)
generate_config

# Fix permissions
fix_permissions

log "Bootstrap complete, starting: $@"
exec "$@"
```

**Step 2: Make script executable**

Run: `chmod +x docker/moodle/entrypoint.sh`
Expected: Script is executable

**Step 3: Verify script syntax**

Run: `bash -n docker/moodle/entrypoint.sh`
Expected: No output (no syntax errors)

**Step 4: Commit**

```bash
git add docker/moodle/entrypoint.sh
git commit -S -m "feat(moodle): add entrypoint script for runtime Moodle download"
```

---

### Task 1.3: Replace Old Moodle Dockerfile

**Files:**
- Remove: `docker/moodle/Dockerfile` (old)
- Rename: `docker/moodle/Dockerfile.new` → `docker/moodle/Dockerfile`

**Step 1: Replace the Dockerfile**

```bash
rm docker/moodle/Dockerfile
mv docker/moodle/Dockerfile.new docker/moodle/Dockerfile
```

**Step 2: Verify**

Run: `head -5 docker/moodle/Dockerfile`
Expected: Shows PHP 8.4 FPM Alpine header

**Step 3: Commit**

```bash
git add docker/moodle/Dockerfile
git commit -S -m "feat(moodle): replace 4.5 Dockerfile with 5.1 PHP-FPM version"
```

---

## Phase 2: nginx Image

### Task 2.1: Create nginx Directory Structure

**Files:**
- Create: `docker/nginx/` directory
- Create: `docker/nginx/ssl/.gitkeep`

**Step 1: Create directories**

```bash
mkdir -p docker/nginx/ssl
touch docker/nginx/ssl/.gitkeep
```

**Step 2: Verify**

Run: `ls -la docker/nginx/`
Expected: Directory exists with ssl subdirectory

**Step 3: Commit**

```bash
git add docker/nginx/
git commit -S -m "chore(nginx): create nginx docker directory structure"
```

---

### Task 2.2: Create nginx Configuration

**Files:**
- Create: `docker/nginx/nginx.conf`

**Step 1: Create nginx.conf**

```nginx
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

load_module modules/ngx_http_brotli_filter_module.so;
load_module modules/ngx_http_brotli_static_module.so;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off;

    # Brotli compression (preferred over gzip)
    brotli on;
    brotli_comp_level 6;
    brotli_static on;
    brotli_types text/plain text/css application/json application/javascript
                 text/xml application/xml application/xml+rss text/javascript
                 image/svg+xml application/x-javascript application/xhtml+xml;

    # Gzip fallback for older clients
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript
               text/xml application/xml application/xml+rss text/javascript
               image/svg+xml application/xhtml+xml;

    # PHP-FPM upstream
    upstream php-fpm {
        server moodle:9000;
    }

    # Docker internal DNS resolver
    resolver 127.0.0.11 valid=30s ipv6=off;

    server {
        listen 80;
        listen 443 ssl;
        listen 443 quic reuseport;
        http2 on;

        server_name _;

        # SSL certificates (self-signed for dev, mount real certs for prod)
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 1d;

        # Advertise HTTP/3 support
        add_header Alt-Svc 'h3=":443"; ma=86400' always;

        # Moodle 5.1: /public is the document root
        root /var/www/html/public;
        index index.php index.html;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Max upload size (match PHP settings)
        client_max_body_size 100M;

        # Static files - serve directly with long cache
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Alt-Svc 'h3=":443"; ma=86400';
            try_files $uri =404;

            # Serve pre-compressed files if available
            gzip_static on;
            brotli_static on;
        }

        # PHP files - proxy to PHP-FPM
        location ~ [^/]\.php(/|$) {
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass php-fpm;
            fastcgi_index index.php;

            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            fastcgi_param HTTPS $https if_not_empty;

            include fastcgi_params;

            # Timeouts for long-running scripts
            fastcgi_read_timeout 300;
            fastcgi_send_timeout 300;
            fastcgi_connect_timeout 60;

            # Buffering
            fastcgi_buffering on;
            fastcgi_buffer_size 16k;
            fastcgi_buffers 16 16k;
        }

        # Default location - try files then PHP
        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        # Moodle dataroot protection (should never be web-accessible)
        location ~ ^/moodledata {
            internal;
        }

        # Block access to sensitive files
        location ~* \.(htaccess|htpasswd|ini|log|sh|sql|conf)$ {
            deny all;
        }

        # Mailpit proxy (optional, graceful failure if not running)
        location /mailpit/ {
            set $mailpit_upstream http://mailpit:8025;
            proxy_pass $mailpit_upstream;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_intercept_errors on;
            error_page 502 503 504 = @mailpit_unavailable;
        }

        location @mailpit_unavailable {
            default_type text/html;
            return 503 '<!DOCTYPE html><html><head><title>Mailpit Unavailable</title></head><body><h1>Mailpit not available</h1><p>Start the mailpit service with: <code>docker compose --profile dev up -d</code></p></body></html>';
        }

        # Health check endpoint for load balancers
        location /nginx-health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # PHP-FPM status (internal only)
        location /fpm-status {
            internal;
            fastcgi_pass php-fpm;
            fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;
            include fastcgi_params;
        }
    }
}
```

**Step 2: Verify syntax (basic check)**

Run: `grep -c "location" docker/nginx/nginx.conf`
Expected: Number > 5 (multiple location blocks)

**Step 3: Commit**

```bash
git add docker/nginx/nginx.conf
git commit -S -m "feat(nginx): add nginx configuration with brotli, HTTP/2, HTTP/3"
```

---

### Task 2.3: Create nginx Dockerfile

**Files:**
- Create: `docker/nginx/Dockerfile`

**Step 1: Create Dockerfile**

```dockerfile
# nginx with Brotli + HTTP/2 + HTTP/3 (QUIC)
# Multi-stage build to compile brotli module

FROM nginx:1.27-alpine AS builder

# Install build dependencies
RUN apk add --no-cache \
    git \
    gcc \
    g++ \
    make \
    pcre-dev \
    openssl-dev \
    zlib-dev \
    linux-headers \
    brotli-dev

# Clone brotli module
RUN git clone --recurse-submodules -j8 \
    https://github.com/google/ngx_brotli.git /tmp/ngx_brotli

# Download nginx source matching installed version
RUN NGINX_VERSION=$(nginx -v 2>&1 | sed 's/.*nginx\///' ) && \
    wget -O /tmp/nginx.tar.gz \
    "https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz" && \
    tar -xzf /tmp/nginx.tar.gz -C /tmp

# Build brotli module as dynamic module
RUN NGINX_VERSION=$(nginx -v 2>&1 | sed 's/.*nginx\///' ) && \
    cd /tmp/nginx-${NGINX_VERSION} && \
    ./configure \
        --with-compat \
        --add-dynamic-module=/tmp/ngx_brotli && \
    make modules && \
    cp objs/ngx_http_brotli_filter_module.so /tmp/ && \
    cp objs/ngx_http_brotli_static_module.so /tmp/

# =============================================================================
# Final image
# =============================================================================
FROM nginx:1.27-alpine

LABEL maintainer="Netresearch <info@netresearch.de>"
LABEL description="nginx with Brotli, HTTP/2, and HTTP/3 for Moodle 5.x"

# Install runtime dependencies
RUN apk add --no-cache \
    brotli-libs \
    curl \
    openssl

# Copy brotli modules from builder
COPY --from=builder /tmp/ngx_http_brotli_filter_module.so /usr/lib/nginx/modules/
COPY --from=builder /tmp/ngx_http_brotli_static_module.so /usr/lib/nginx/modules/

# Create SSL directory
RUN mkdir -p /etc/nginx/ssl

# Generate self-signed certificate for development
# Production deployments should mount real certificates
RUN openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /etc/nginx/ssl/key.pem \
    -out /etc/nginx/ssl/cert.pem \
    -subj "/CN=localhost/O=Moodle Docker/C=DE"

# Copy nginx configuration
COPY nginx.conf /etc/nginx/nginx.conf

# Healthcheck
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD curl -f http://localhost/nginx-health || exit 1

# Expose HTTP, HTTPS (TCP), and HTTPS (UDP for HTTP/3)
EXPOSE 80 443 443/udp

CMD ["nginx", "-g", "daemon off;"]
```

**Step 2: Verify file exists**

Run: `ls -la docker/nginx/Dockerfile`
Expected: File exists

**Step 3: Commit**

```bash
git add docker/nginx/Dockerfile
git commit -S -m "feat(nginx): add Dockerfile with brotli module compilation"
```

---

## Phase 3: Docker Compose

### Task 3.1: Create New Compose File

**Files:**
- Backup: `compose.yml` → `compose.yml.v4`
- Create: `compose.yml` (new)

**Step 1: Backup old compose file**

```bash
cp compose.yml compose.yml.v4
```

**Step 2: Create new compose.yml**

```yaml
# Moodle 5.1 Production Stack
# PHP-FPM + nginx + MariaDB 11.8 + Valkey 9 + Ofelia + Mailpit

services:
  # ==========================================================================
  # nginx - Web Server
  # ==========================================================================
  nginx:
    image: netresearch/moodle-nginx:latest
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443/tcp"
      - "${HTTPS_PORT:-443}:443/udp"  # HTTP/3 QUIC
    volumes:
      - moodle_code:/var/www/html:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - frontend
      - backend
    depends_on:
      moodle:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # Moodle - PHP-FPM Application
  # ==========================================================================
  moodle:
    image: netresearch/moodle:${MOODLE_VERSION:-5.1}
    build:
      context: ./docker/moodle
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_app
    restart: unless-stopped
    volumes:
      - moodle_code:/var/www/html
      - moodledata:/var/moodledata
    environment:
      - MOODLE_VERSION=${MOODLE_VERSION:-5.1.2}
      - MOODLE_URL=${MOODLE_URL:-http://localhost}
      - DB_TYPE=${DB_TYPE:-mariadb}
      - DB_HOST=${DB_HOST:-database}
      - DB_NAME=${DB_NAME:-moodle}
      - DB_USER=${DB_USER:-moodle}
      - DB_PASSWORD=${DB_PASSWORD:?DB_PASSWORD is required}
      - DB_PREFIX=${DB_PREFIX:-mdl_}
      - VALKEY_HOST=${VALKEY_HOST:-valkey}
      - VALKEY_PORT=${VALKEY_PORT:-6379}
      - VALKEY_PASSWORD=${VALKEY_PASSWORD:?VALKEY_PASSWORD is required}
      - SMTP_HOST=${SMTP_HOST:-mailpit}
      - SMTP_PORT=${SMTP_PORT:-1025}
      - SMTP_NOREPLY=${SMTP_NOREPLY:-noreply@example.com}
      - SSL_PROXY=${SSL_PROXY:-false}
      - MOODLE_DEBUG=${MOODLE_DEBUG:-false}
    networks:
      - backend
    depends_on:
      database:
        condition: service_healthy
      valkey:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "php-fpm-healthcheck"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 120s  # Allow time for Moodle download

  # ==========================================================================
  # Moodle Cron - Dedicated Container for Scheduled Tasks
  # ==========================================================================
  moodle-cron:
    image: netresearch/moodle:${MOODLE_VERSION:-5.1}
    build:
      context: ./docker/moodle
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_cron
    restart: unless-stopped
    command: ["sleep", "infinity"]
    volumes:
      - moodle_code:/var/www/html:ro
      - moodledata:/var/moodledata
    environment:
      - MOODLE_SKIP_BOOTSTRAP=true
      - DB_TYPE=${DB_TYPE:-mariadb}
      - DB_HOST=${DB_HOST:-database}
      - DB_NAME=${DB_NAME:-moodle}
      - DB_USER=${DB_USER:-moodle}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_PREFIX=${DB_PREFIX:-mdl_}
      - VALKEY_HOST=${VALKEY_HOST:-valkey}
      - VALKEY_PORT=${VALKEY_PORT:-6379}
      - VALKEY_PASSWORD=${VALKEY_PASSWORD}
    networks:
      - backend
    depends_on:
      moodle:
        condition: service_healthy
    labels:
      ofelia.enabled: "true"
      ofelia.job-exec.moodle-cron.schedule: "@every 1m"
      ofelia.job-exec.moodle-cron.command: "php /var/www/html/admin/cli/cron.php"
      ofelia.job-exec.moodle-cron.user: "www-data"

  # ==========================================================================
  # MariaDB 11.8 LTS - Database
  # ==========================================================================
  database:
    image: mariadb:11.8
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_database
    restart: unless-stopped
    volumes:
      - db_data:/var/lib/mysql
      - ./docker/mariadb/custom.cnf:/etc/mysql/conf.d/custom.cnf:ro
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:?DB_ROOT_PASSWORD is required}
      - MYSQL_DATABASE=${DB_NAME:-moodle}
      - MYSQL_USER=${DB_USER:-moodle}
      - MYSQL_PASSWORD=${DB_PASSWORD:?DB_PASSWORD is required}
    networks:
      - backend
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==========================================================================
  # Valkey 9 - Redis-Compatible Cache & Sessions
  # ==========================================================================
  valkey:
    image: valkey/valkey:9-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_valkey
    restart: unless-stopped
    command: >
      valkey-server
      --requirepass ${VALKEY_PASSWORD:?VALKEY_PASSWORD is required}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
    volumes:
      - valkey_data:/data
    networks:
      - backend
    healthcheck:
      test: ["CMD", "valkey-cli", "--no-auth-warning", "-a", "${VALKEY_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # Ofelia - Cron Scheduler
  # ==========================================================================
  ofelia:
    image: netresearch/ofelia:latest
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_ofelia
    restart: unless-stopped
    command: daemon --docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - backend
    depends_on:
      - moodle-cron

  # ==========================================================================
  # Mailpit - Development Mail Catcher (Optional)
  # ==========================================================================
  mailpit:
    image: axllent/mailpit:latest
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_mailpit
    restart: unless-stopped
    profiles:
      - dev
      - mail
    networks:
      - backend
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8025"]
      interval: 30s
      timeout: 5s
      retries: 3

# =============================================================================
# Networks
# =============================================================================
networks:
  frontend:
    name: ${COMPOSE_PROJECT_NAME:-moodle}_frontend
  backend:
    name: ${COMPOSE_PROJECT_NAME:-moodle}_backend
    internal: true

# =============================================================================
# Volumes
# =============================================================================
volumes:
  moodle_code:
    name: ${COMPOSE_PROJECT_NAME:-moodle}_code
  moodledata:
    name: ${COMPOSE_PROJECT_NAME:-moodle}_data
  db_data:
    name: ${COMPOSE_PROJECT_NAME:-moodle}_db
  valkey_data:
    name: ${COMPOSE_PROJECT_NAME:-moodle}_valkey
```

**Step 3: Validate compose syntax**

Run: `docker compose config > /dev/null && echo "Valid"`
Expected: "Valid" (no errors)

**Step 4: Commit**

```bash
git add compose.yml compose.yml.v4
git commit -S -m "feat(compose): add Moodle 5.1 compose configuration

- PHP-FPM + nginx separated architecture
- MariaDB 11.8 LTS, Valkey 9
- Dedicated cron container with Ofelia
- Optional mailpit for development"
```

---

### Task 3.2: Update .env.example

**Files:**
- Modify: `.env.example`

**Step 1: Create new .env.example**

```env
# =============================================================================
# Moodle 5.1 Docker Stack Configuration
# =============================================================================

# Project name (used for container and volume prefixes)
COMPOSE_PROJECT_NAME=moodle

# =============================================================================
# Moodle Settings
# =============================================================================

# Moodle version to install (downloaded by entrypoint)
MOODLE_VERSION=5.1.2

# Full URL to your Moodle site (no trailing slash)
MOODLE_URL=http://localhost

# Set to true if behind SSL-terminating proxy (Traefik, CloudFlare, etc.)
SSL_PROXY=false

# Enable Moodle debug mode (set to true for development)
MOODLE_DEBUG=false

# =============================================================================
# Database Settings
# =============================================================================

# Database type (mariadb or pgsql)
DB_TYPE=mariadb

# Database host (use 'database' for the included MariaDB container)
DB_HOST=database

# Database name
DB_NAME=moodle

# Database user
DB_USER=moodle

# Database password (CHANGE THIS!)
DB_PASSWORD=CHANGE_ME_SECURE_PASSWORD

# Database root password (CHANGE THIS!)
DB_ROOT_PASSWORD=CHANGE_ME_SECURE_ROOT_PASSWORD

# Table prefix
DB_PREFIX=mdl_

# =============================================================================
# Valkey (Redis-compatible) Settings
# =============================================================================

# Valkey host
VALKEY_HOST=valkey

# Valkey port
VALKEY_PORT=6379

# Valkey password (CHANGE THIS!)
VALKEY_PASSWORD=CHANGE_ME_SECURE_VALKEY_PASSWORD

# =============================================================================
# Email Settings
# =============================================================================

# SMTP host (use 'mailpit' for development mail catcher)
SMTP_HOST=mailpit

# SMTP port
SMTP_PORT=1025

# No-reply email address
SMTP_NOREPLY=noreply@example.com

# =============================================================================
# Port Configuration
# =============================================================================

# HTTP port
HTTP_PORT=80

# HTTPS port
HTTPS_PORT=443
```

**Step 2: Verify**

Run: `grep MOODLE_VERSION .env.example`
Expected: `MOODLE_VERSION=5.1.2`

**Step 3: Commit**

```bash
git add .env.example
git commit -S -m "feat(env): update .env.example for Moodle 5.1 stack"
```

---

## Phase 4: CI/CD

### Task 4.1: Update Docker Build Workflow

**Files:**
- Modify: `.github/workflows/docker-build.yml`

**Step 1: Update workflow for multi-image build**

Replace the entire file with updated workflow that builds both moodle and nginx images, updates version checks for PHP 8.4 and Moodle 5.1.

**Step 2: Commit**

```bash
git add .github/workflows/docker-build.yml
git commit -S -m "ci: update docker-build workflow for Moodle 5.1 images"
```

---

## Phase 5: Documentation

### Task 5.1: Update README.md

**Files:**
- Modify: `README.md`

**Step 1: Update README with new architecture**

Update title, badges, architecture diagram, version info, quick start, and all commands to reflect Moodle 5.1 / PHP 8.4 / nginx architecture.

**Step 2: Commit**

```bash
git add README.md
git commit -S -m "docs: update README for Moodle 5.1 architecture"
```

---

### Task 5.2: Update QUICKSTART.md

**Files:**
- Modify: `QUICKSTART.md`

**Step 1: Update quickstart guide**

Update all version references, commands, and instructions for the new architecture.

**Step 2: Commit**

```bash
git add QUICKSTART.md
git commit -S -m "docs: update QUICKSTART for Moodle 5.1"
```

---

## Phase 6: Cleanup

### Task 6.1: Remove Obsolete Files

**Files:**
- Remove: `config/moodle-config.php` (now generated by entrypoint)
- Remove: `docker/valkey/valkey.conf` (now inline in compose)
- Update: `.gitignore`

**Step 1: Remove obsolete config**

```bash
rm -f config/moodle-config.php
rm -f docker/valkey/valkey.conf
rmdir docker/valkey 2>/dev/null || true
rmdir config 2>/dev/null || true
```

**Step 2: Update .gitignore**

Add entries for generated files.

**Step 3: Commit**

```bash
git add -A
git commit -S -m "chore: remove obsolete config files (now generated at runtime)"
```

---

### Task 6.2: Final Integration Test

**Step 1: Build images locally**

```bash
docker compose build
```

Expected: Both moodle and nginx images build successfully

**Step 2: Create test .env**

```bash
cp .env.example .env
sed -i 's/CHANGE_ME_SECURE_PASSWORD/testpass123/g' .env
sed -i 's/CHANGE_ME_SECURE_ROOT_PASSWORD/testrootpass123/g' .env
sed -i 's/CHANGE_ME_SECURE_VALKEY_PASSWORD/testvalkey123/g' .env
```

**Step 3: Start stack**

```bash
docker compose up -d
```

**Step 4: Verify services**

```bash
docker compose ps
```

Expected: All services healthy

**Step 5: Cleanup test**

```bash
docker compose down -v
rm .env
```

---

## Summary

| Phase | Tasks | Description |
|-------|-------|-------------|
| 1 | 1.1-1.3 | Moodle PHP-FPM image (Dockerfile + entrypoint) |
| 2 | 2.1-2.3 | nginx image (config + Dockerfile) |
| 3 | 3.1-3.2 | Docker Compose + .env.example |
| 4 | 4.1 | CI/CD workflow updates |
| 5 | 5.1-5.2 | Documentation updates |
| 6 | 6.1-6.2 | Cleanup + integration test |

**Total commits:** ~12 atomic commits
**Estimated tasks:** 15 discrete tasks
