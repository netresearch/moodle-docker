# Moodle 5.1 Docker Stack - Architecture Redesign

**Date:** 2026-01-26
**Status:** Approved
**Author:** Claude + User collaboration

---

## 1. Overview & Goals

### Purpose

Complete redesign of the netresearch/moodle-docker stack to support Moodle 5.1, addressing the fundamental architectural changes introduced in the Moodle 5.x series.

### Goals

1. **Simple upgrades**: `docker compose pull && docker compose up -d` to upgrade Moodle
2. **Runtime flexibility**: Moodle version configurable via environment variable
3. **Plugin-friendly**: Support web UI plugin installation/updates
4. **Modern architecture**: Separated PHP-FPM + nginx pattern
5. **Production-ready**: Suitable for production deployments with Traefik integration

### Target Stack Versions

| Component | Version | Notes |
|-----------|---------|-------|
| Moodle | 5.1.x | First version with `/public` directory structure |
| PHP | 8.4 | Highest supported by Moodle 5.1 |
| MariaDB | 11.8 LTS | Latest long-term support |
| Valkey | 9 (alpine) | Redis-compatible cache |
| nginx | alpine + brotli | Custom build with HTTP/3 |

### Key Architectural Changes from 4.5

- **Moodle 5.1 `/public` directory**: Web root is now `/public`, not Moodle root
- **Separated concerns**: PHP-FPM and nginx as separate containers
- **No baked-in code**: Runtime image contains only PHP environment; Moodle downloaded by entrypoint
- **Config from environment**: `config.php` generated from env vars on each start

---

## 2. Service Architecture

### Container Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                     Docker Compose Stack                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────┐    ┌─────────────┐    ┌──────────────────────┐    │
│  │  nginx  │───▶│   moodle    │───▶│      database        │    │
│  │ :80/:443│    │  (php-fpm)  │    │    (mariadb:11.8)    │    │
│  └────┬────┘    └──────┬──────┘    └──────────────────────┘    │
│       │                │                                        │
│       │                │           ┌──────────────────────┐    │
│       │                └──────────▶│       valkey         │    │
│       │                            │   (cache+sessions)   │    │
│       │                            └──────────────────────┘    │
│       │                                                        │
│       │  /mailpit/     ┌──────────────────────┐               │
│       └───────────────▶│      mailpit         │               │
│                        │    (mail catcher)    │               │
│                        └──────────────────────┘               │
│                                                                │
│  ┌──────────────────────┐    ┌──────────────────────┐        │
│  │       ofelia         │───▶│    moodle-cron       │        │
│  │   (cron scheduler)   │exec│  (dedicated cron)    │        │
│  └──────────────────────┘    └──────────────────────┘        │
│                                                                │
└─────────────────────────────────────────────────────────────────┘
```

### Services

| Service | Image | Role | Replicas |
|---------|-------|------|----------|
| nginx | `netresearch/moodle-nginx` | Reverse proxy, static files, SSL termination | 1 |
| moodle | `netresearch/moodle:5.1` | PHP-FPM 8.4, entrypoint manages Moodle code | 1+ (scalable) |
| moodle-cron | `netresearch/moodle:5.1` | Dedicated cron container, Ofelia exec's into | 1 |
| database | `mariadb:11.8` | Persistent data storage | 1 |
| valkey | `valkey/valkey:9-alpine` | Session storage, MUC cache | 1 |
| ofelia | `netresearch/ofelia` | Executes Moodle cron every minute | 1 |
| mailpit | `axllent/mailpit` | Development mail catcher (optional) | 0-1 |

### Networks

| Network | Purpose | Services |
|---------|---------|----------|
| frontend | External access | nginx |
| backend | Internal communication | all services |

---

## 3. Volume Architecture & Data Persistence

### Volumes

| Volume | Mount Point | Purpose | Backup Priority |
|--------|-------------|---------|-----------------|
| `moodle_code` | `/var/www/html` | Moodle application code + user plugins | Low (regenerable) |
| `moodledata` | `/var/moodledata` | User uploads, cache, temp files | **High** |
| `db_data` | `/var/lib/mysql` | MariaDB database files | **Critical** |
| `valkey_data` | `/data` | Session/cache persistence | Low (ephemeral OK) |

### Moodle Code Volume (`moodle_code`)

This volume contains:
```
/var/www/html/
├── .moodle-version          # Version marker (written by entrypoint)
├── public/                  # Web root (Moodle 5.1 structure)
│   ├── index.php
│   ├── config.php           # Generated from env vars
│   ├── mod/                 # Activity modules (core + user-installed)
│   ├── theme/               # Themes (core + user-installed)
│   ├── local/               # Local plugins (user-installed)
│   ├── blocks/              # Blocks (core + user-installed)
│   └── ...
├── lib/
├── admin/
└── ...
```

**Key behaviors:**
- **First start**: Entrypoint downloads Moodle, extracts to volume
- **Subsequent starts**: Entrypoint checks version, skips download if current
- **Upgrades**: New `MOODLE_VERSION` triggers download, preserving user plugins
- **Plugin updates**: Written directly by Moodle web UI, persisted in volume

### Data Backup Strategy

```bash
# Critical: Database
docker compose exec database mysqldump -u root -p moodle | gzip > db-backup.sql.gz

# Important: User files
docker run --rm -v moodledata:/data alpine tar czf - /data > moodledata-backup.tar.gz

# Optional: Code (only if custom plugins not in git)
docker run --rm -v moodle_code:/data alpine tar czf - /data > code-backup.tar.gz
```

---

## 4. Entrypoint Logic

### Entrypoint Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      Container Start                             │
└─────────────────────────┬───────────────────────────────────────┘
                          ▼
              ┌───────────────────────┐
              │  Check MOODLE_VERSION │
              │  vs .moodle-version   │
              └───────────┬───────────┘
                          ▼
                   ┌──────────────┐
                   │   Match?     │
                   └──────┬───────┘
                     no   │   yes
            ┌─────────────┴─────────────┐
            ▼                           ▼
┌───────────────────────┐    ┌─────────────────────┐
│  Download Moodle      │    │  Skip download      │
│  - Backup user plugins│    │                     │
│  - Extract new code   │    │                     │
│  - Restore plugins    │    │                     │
│  - Write .moodle-ver  │    │                     │
└───────────┬───────────┘    └──────────┬──────────┘
            └─────────────┬─────────────┘
                          ▼
              ┌───────────────────────┐
              │  Generate config.php  │
              │  from environment     │
              └───────────┬───────────┘
                          ▼
              ┌───────────────────────┐
              │  Fix permissions      │
              │  www-data ownership   │
              └───────────┬───────────┘
                          ▼
              ┌───────────────────────┐
              │  exec php-fpm / CMD   │
              └───────────────────────┘
```

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `MOODLE_VERSION` | `5.1.2` | Moodle version to install |
| `MOODLE_URL` | `http://localhost` | Full site URL |
| `DB_TYPE` | `mariadb` | Database type |
| `DB_HOST` | `database` | Database hostname |
| `DB_NAME` | `moodle` | Database name |
| `DB_USER` | `moodle` | Database user |
| `DB_PASSWORD` | *required* | Database password |
| `DB_PREFIX` | `mdl_` | Table prefix |
| `VALKEY_HOST` | `valkey` | Valkey hostname |
| `VALKEY_PORT` | `6379` | Valkey port |
| `VALKEY_PASSWORD` | *required* | Valkey password |
| `SMTP_HOST` | `mailpit` | SMTP server |
| `SMTP_PORT` | `1025` | SMTP port |
| `SSL_PROXY` | `false` | Behind SSL terminator |

---

## 5. nginx Configuration

### Key Requirements

1. Serve Moodle 5.1's `/public` directory as web root
2. Proxy PHP requests to php-fpm container
3. Serve static files directly (performance)
4. Brotli + gzip compression
5. HTTP/2 + HTTP/3 (QUIC) support
6. Optional: Proxy `/mailpit/` to mailpit container (graceful failure)
7. Support Traefik integration for production SSL

### nginx.conf

```nginx
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

load_module modules/ngx_http_brotli_filter_module.so;
load_module modules/ngx_http_brotli_static_module.so;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Brotli compression (preferred)
    brotli on;
    brotli_comp_level 6;
    brotli_static on;
    brotli_types text/plain text/css application/json application/javascript
                 text/xml application/xml application/xml+rss text/javascript
                 image/svg+xml application/x-javascript;

    # Gzip fallback
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript
               text/xml application/xml application/xml+rss text/javascript
               image/svg+xml;

    upstream php-fpm {
        server moodle:9000;
    }

    resolver 127.0.0.11 valid=30s ipv6=off;

    server {
        listen 80;
        listen 443 ssl;
        listen 443 quic reuseport;
        http2 on;

        server_name _;

        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers off;

        add_header Alt-Svc 'h3=":443"; ma=86400' always;

        root /var/www/html/public;
        index index.php index.html;

        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        client_max_body_size 100M;

        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Alt-Svc 'h3=":443"; ma=86400';
            try_files $uri =404;
        }

        location ~* \.(js|css)$ {
            gzip_static on;
            brotli_static on;
        }

        location ~ [^/]\.php(/|$) {
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass php-fpm;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            include fastcgi_params;
            fastcgi_read_timeout 300;
            fastcgi_send_timeout 300;
        }

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location /mailpit/ {
            set $mailpit_upstream http://mailpit:8025;
            proxy_pass $mailpit_upstream;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_intercept_errors on;
            error_page 502 503 = @mailpit_unavailable;
        }

        location @mailpit_unavailable {
            default_type text/html;
            return 503 "<html><body><h1>Mailpit not available</h1></body></html>";
        }

        location /nginx-health {
            access_log off;
            return 200 "healthy\n";
        }
    }
}
```

---

## 6. Docker Compose Configuration

### compose.yml

```yaml
services:
  nginx:
    image: netresearch/moodle-nginx:latest
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443/tcp"
      - "${HTTPS_PORT:-443}:443/udp"
    volumes:
      - moodle_code:/var/www/html:ro
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - frontend
      - backend
    depends_on:
      moodle:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 5s
      retries: 3

  moodle:
    image: netresearch/moodle:${MOODLE_VERSION:-5.1}
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_app
    restart: unless-stopped
    volumes:
      - moodle_code:/var/www/html
      - moodledata:/var/moodledata
    environment:
      - MOODLE_VERSION=${MOODLE_VERSION:-5.1.2}
      - MOODLE_URL=${MOODLE_URL:-http://localhost}
      - DB_TYPE=${DB_TYPE:-mariadb}
      - DB_HOST=${DB_HOST:-database}
      - DB_NAME=${DB_NAME:-moodle}
      - DB_USER=${DB_USER:-moodle}
      - DB_PASSWORD=${DB_PASSWORD:?DB_PASSWORD required}
      - DB_PREFIX=${DB_PREFIX:-mdl_}
      - VALKEY_HOST=${VALKEY_HOST:-valkey}
      - VALKEY_PORT=${VALKEY_PORT:-6379}
      - VALKEY_PASSWORD=${VALKEY_PASSWORD:?VALKEY_PASSWORD required}
      - SMTP_HOST=${SMTP_HOST:-mailpit}
      - SMTP_PORT=${SMTP_PORT:-1025}
      - SSL_PROXY=${SSL_PROXY:-false}
    networks:
      - backend
    depends_on:
      database:
        condition: service_healthy
      valkey:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "php-fpm-healthcheck"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  moodle-cron:
    image: netresearch/moodle:${MOODLE_VERSION:-5.1}
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_cron
    restart: unless-stopped
    command: ["sleep", "infinity"]
    volumes:
      - moodle_code:/var/www/html:ro
      - moodledata:/var/moodledata
    environment:
      - MOODLE_SKIP_BOOTSTRAP=true
      - DB_HOST=${DB_HOST:-database}
      - DB_PASSWORD=${DB_PASSWORD}
      - VALKEY_HOST=${VALKEY_HOST:-valkey}
      - VALKEY_PASSWORD=${VALKEY_PASSWORD}
    networks:
      - backend
    depends_on:
      - moodle
    labels:
      ofelia.enabled: "true"
      ofelia.job-exec.cron.schedule: "@every 1m"
      ofelia.job-exec.cron.command: "php /var/www/html/public/admin/cli/cron.php"
      ofelia.job-exec.cron.user: "www-data"

  database:
    image: mariadb:11.8
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_database
    restart: unless-stopped
    volumes:
      - db_data:/var/lib/mysql
      - ./docker/mariadb/custom.cnf:/etc/mysql/conf.d/custom.cnf:ro
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:?DB_ROOT_PASSWORD required}
      - MYSQL_DATABASE=${DB_NAME:-moodle}
      - MYSQL_USER=${DB_USER:-moodle}
      - MYSQL_PASSWORD=${DB_PASSWORD:?DB_PASSWORD required}
    networks:
      - backend
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  valkey:
    image: valkey/valkey:9-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_valkey
    restart: unless-stopped
    command: >
      valkey-server
      --requirepass ${VALKEY_PASSWORD:?VALKEY_PASSWORD required}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - valkey_data:/data
    networks:
      - backend
    healthcheck:
      test: ["CMD", "valkey-cli", "--no-auth-warning", "-a", "${VALKEY_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  ofelia:
    image: netresearch/ofelia:latest
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_ofelia
    restart: unless-stopped
    command: daemon --docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - backend
    depends_on:
      - moodle-cron

  mailpit:
    image: axllent/mailpit:latest
    container_name: ${COMPOSE_PROJECT_NAME:-moodle}_mailpit
    restart: unless-stopped
    profiles:
      - dev
      - mail
    networks:
      - backend
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8025"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  frontend:
    name: ${COMPOSE_PROJECT_NAME:-moodle}_frontend
  backend:
    name: ${COMPOSE_PROJECT_NAME:-moodle}_backend
    internal: true

volumes:
  moodle_code:
    name: ${COMPOSE_PROJECT_NAME:-moodle}_code
  moodledata:
    name: ${COMPOSE_PROJECT_NAME:-moodle}_data
  db_data:
    name: ${COMPOSE_PROJECT_NAME:-moodle}_db
  valkey_data:
    name: ${COMPOSE_PROJECT_NAME:-moodle}_valkey
```

---

## 7. Dockerfile - Moodle PHP-FPM Image

### docker/moodle/Dockerfile

```dockerfile
FROM php:8.4-fpm-alpine

LABEL maintainer="Netresearch <info@netresearch.de>"
LABEL description="Moodle 5.x PHP-FPM runtime"

ARG BUILD_DEPS="autoconf g++ make libpng-dev libjpeg-turbo-dev freetype-dev \
    libxml2-dev icu-dev libzip-dev libsodium-dev oniguruma-dev \
    postgresql-dev openldap-dev bzip2-dev curl-dev"

ARG RUNTIME_DEPS="bash curl git unzip \
    libpng libjpeg-turbo freetype libxml2 icu-libs libzip libsodium \
    oniguruma postgresql-libs libldap libbz2 \
    fcgi"

RUN apk add --no-cache $RUNTIME_DEPS $BUILD_DEPS \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-configure ldap \
    && docker-php-ext-install -j$(nproc) \
        mysqli pdo_mysql \
        pgsql pdo_pgsql \
        gd \
        xml soap \
        intl \
        mbstring \
        zip bz2 \
        bcmath \
        opcache \
        ldap \
        sodium \
        exif \
        sockets \
        pcntl \
    && pecl install redis igbinary apcu \
    && docker-php-ext-enable redis igbinary apcu \
    && apk del $BUILD_DEPS \
    && rm -rf /tmp/* /var/cache/apk/*

RUN { \
    echo 'memory_limit = 256M'; \
    echo 'upload_max_filesize = 100M'; \
    echo 'post_max_size = 100M'; \
    echo 'max_execution_time = 300'; \
    echo 'max_input_vars = 5000'; \
    echo 'file_uploads = On'; \
    echo 'session.save_handler = files'; \
    echo 'display_errors = Off'; \
    echo 'log_errors = On'; \
} > /usr/local/etc/php/conf.d/moodle.ini

RUN { \
    echo 'opcache.enable=1'; \
    echo 'opcache.memory_consumption=256'; \
    echo 'opcache.interned_strings_buffer=16'; \
    echo 'opcache.max_accelerated_files=20000'; \
    echo 'opcache.revalidate_freq=60'; \
    echo 'opcache.fast_shutdown=1'; \
    echo 'opcache.enable_cli=0'; \
    echo 'opcache.jit=1255'; \
    echo 'opcache.jit_buffer_size=128M'; \
} > /usr/local/etc/php/conf.d/opcache.ini

RUN { \
    echo '[www]'; \
    echo 'pm = dynamic'; \
    echo 'pm.max_children = 50'; \
    echo 'pm.start_servers = 5'; \
    echo 'pm.min_spare_servers = 5'; \
    echo 'pm.max_spare_servers = 35'; \
    echo 'pm.max_requests = 500'; \
    echo 'pm.status_path = /status'; \
    echo 'ping.path = /ping'; \
    echo 'ping.response = pong'; \
} > /usr/local/etc/php-fpm.d/zz-moodle.conf

RUN echo '#!/bin/sh' > /usr/local/bin/php-fpm-healthcheck \
    && echo 'SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:9000 | grep -q pong' >> /usr/local/bin/php-fpm-healthcheck \
    && chmod +x /usr/local/bin/php-fpm-healthcheck

RUN mkdir -p /var/www/html /var/moodledata \
    && chown -R www-data:www-data /var/www/html /var/moodledata

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

WORKDIR /var/www/html

USER www-data

EXPOSE 9000

ENTRYPOINT ["/entrypoint.sh"]
CMD ["php-fpm"]
```

---

## 8. Dockerfile - nginx Image

### docker/nginx/Dockerfile

```dockerfile
FROM nginx:1.27-alpine AS builder

RUN apk add --no-cache \
    git gcc g++ make pcre-dev openssl-dev zlib-dev linux-headers \
    brotli-dev

RUN git clone --recurse-submodules https://github.com/google/ngx_brotli.git /tmp/ngx_brotli

RUN NGINX_VERSION=$(nginx -v 2>&1 | sed 's/.*nginx\///' ) && \
    wget -O /tmp/nginx.tar.gz "https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz" && \
    tar -xzf /tmp/nginx.tar.gz -C /tmp

RUN NGINX_VERSION=$(nginx -v 2>&1 | sed 's/.*nginx\///' ) && \
    cd /tmp/nginx-${NGINX_VERSION} && \
    ./configure \
        --with-compat \
        --add-dynamic-module=/tmp/ngx_brotli && \
    make modules && \
    cp objs/ngx_http_brotli_filter_module.so /tmp/ && \
    cp objs/ngx_http_brotli_static_module.so /tmp/

FROM nginx:1.27-alpine

RUN apk add --no-cache brotli-libs curl

COPY --from=builder /tmp/ngx_http_brotli_filter_module.so /usr/lib/nginx/modules/
COPY --from=builder /tmp/ngx_http_brotli_static_module.so /usr/lib/nginx/modules/

RUN mkdir -p /etc/nginx/ssl

RUN apk add --no-cache openssl && \
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
        -keyout /etc/nginx/ssl/key.pem \
        -out /etc/nginx/ssl/cert.pem \
        -subj "/CN=localhost" && \
    apk del openssl

COPY nginx.conf /etc/nginx/nginx.conf

HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
    CMD curl -f http://localhost/nginx-health || exit 1

EXPOSE 80 443 443/udp

CMD ["nginx", "-g", "daemon off;"]
```

---

## 9. Upgrade & Operations

### Moodle Upgrade Workflow

```bash
# 1. Update version in .env
sed -i 's/MOODLE_VERSION=.*/MOODLE_VERSION=5.2.0/' .env

# 2. Restart containers (entrypoint downloads new version)
docker compose up -d

# 3. Run Moodle upgrade
docker compose exec moodle php public/admin/cli/upgrade.php --non-interactive
```

### Commands Reference

```bash
# Installation
docker compose up -d
docker compose exec moodle php public/admin/cli/install.php \
    --lang=en \
    --wwwroot="${MOODLE_URL}" \
    --dataroot=/var/moodledata \
    --dbtype=mariadb \
    --dbhost=database \
    --dbname=moodle \
    --dbuser=moodle \
    --dbpass="${DB_PASSWORD}" \
    --fullname="My Moodle" \
    --shortname="Moodle" \
    --adminuser=admin \
    --adminpass=ChangeMeNow123! \
    --adminemail=admin@example.com \
    --non-interactive \
    --agree-license

# Maintenance
docker compose exec moodle php public/admin/cli/maintenance.php --enable
docker compose exec moodle php public/admin/cli/maintenance.php --disable
docker compose exec moodle php public/admin/cli/purge_caches.php

# Backup
docker compose exec database mysqldump -u root -p"${DB_ROOT_PASSWORD}" moodle | gzip > backup-db-$(date +%Y%m%d).sql.gz
docker run --rm -v ${COMPOSE_PROJECT_NAME}_data:/data:ro alpine tar czf - -C /data . > backup-data-$(date +%Y%m%d).tar.gz

# Development with mailpit
docker compose --profile dev up -d
```

---

## 10. Summary & Implementation Plan

### Images to Build

| Image | Purpose |
|-------|---------|
| `netresearch/moodle:5.1` | PHP-FPM 8.4 + entrypoint |
| `netresearch/moodle:5` | Alias to latest 5.x |
| `netresearch/moodle-nginx:latest` | nginx + brotli + HTTP/3 |

### Repository Structure

```
moodle-docker/
├── docker/
│   ├── moodle/
│   │   ├── Dockerfile
│   │   └── entrypoint.sh
│   ├── nginx/
│   │   ├── Dockerfile
│   │   └── nginx.conf
│   └── mariadb/
│       └── custom.cnf
├── compose.yml
├── compose.override.yml.example
├── .env.example
├── README.md
├── QUICKSTART.md
└── docs/
    └── plans/
        └── 2026-01-26-moodle-5.1-design.md
```

### Implementation Phases

| Phase | Tasks |
|-------|-------|
| **1. Foundation** | Create Dockerfiles, entrypoint script, nginx config |
| **2. Compose** | Write compose.yml, .env.example |
| **3. Testing** | Test fresh install, upgrade, plugin install |
| **4. CI/CD** | GitHub Actions for image builds |
| **5. Documentation** | README, QUICKSTART, migration guide |

### Migration from 4.5

1. Backup database and moodledata
2. Deploy new stack with fresh volumes
3. Restore database
4. Restore moodledata
5. Run Moodle upgrade CLI
6. Reinstall plugins (or restore from backup)

---

## References

- [Moodle 5.1 Release Notes](https://moodledev.io/general/releases/5.1)
- [Moodle 5.1 Public Folder Structure](https://elearning.3rdwavemedia.com/blog/moodle-5-upgrade-guide-public-folder-structure/7321/)
- [MariaDB 11.8 LTS](https://mariadb.com/resources/blog/latest-lts-version-of-mariadb-community-server-11-8-is-now-available/)
- [Valkey Releases](https://github.com/valkey-io/valkey/releases)
