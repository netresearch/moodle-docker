# Valkey 9 Configuration for Moodle
# Redis-compatible cache and session storage

# ============================================================================
# Network
# ============================================================================
# Bind to all interfaces (Docker network isolation handles security)
bind 0.0.0.0

# Port
port 6379

# TCP backlog
tcp-backlog 511

# Timeout (0 = no timeout)
timeout 0

# TCP keepalive
tcp-keepalive 300

# ============================================================================
# General
# ============================================================================
# Run as daemon (Docker handles this)
daemonize no

# Supervised by Docker
supervised no

# PID file
pidfile /var/run/valkey.pid

# Log level: debug, verbose, notice, warning
loglevel notice

# Log to stdout (Docker captures)
logfile ""

# Number of databases
databases 16

# ============================================================================
# Snapshotting (Persistence)
# ============================================================================
# Save snapshot to disk
# Format: save <seconds> <changes>
save 900 1      # After 900 sec (15 min) if at least 1 key changed
save 300 10     # After 300 sec (5 min) if at least 10 keys changed
save 60 10000   # After 60 sec if at least 10000 keys changed

# Stop writes on background save error
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes

# Checksum RDB files
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# Working directory
dir /data

# ============================================================================
# Replication (Disabled - single instance)
# ============================================================================
# Not needed for single-instance Moodle deployment

# ============================================================================
# Security
# ============================================================================
# Require password (set via command line --requirepass)
# requirepass is set via docker-compose command argument

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""

# ============================================================================
# Memory Management
# ============================================================================
# Maximum memory (adjust based on available RAM)
maxmemory 512mb

# Eviction policy when maxmemory is reached
# allkeys-lru: Evict least recently used keys
# volatile-lru: Evict LRU among keys with expiration
# allkeys-random: Random eviction
# volatile-random: Random among keys with expiration
# volatile-ttl: Evict keys with shortest TTL
# noeviction: Return errors when memory limit is reached
maxmemory-policy allkeys-lru

# LRU and minimal TTL algorithms are approximations
maxmemory-samples 5

# ============================================================================
# Append Only File (AOF) - Better persistence than RDB
# ============================================================================
# Enable AOF
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# Fsync policy
# always: fsync after every write (slowest, safest)
# everysec: fsync every second (good balance)
# no: let OS handle fsync (fastest, least safe)
appendfsync everysec

# Don't fsync during rewrite
no-appendfsync-on-rewrite no

# Auto AOF rewrite
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Load truncated AOF
aof-load-truncated yes

# Use RDB-AOF hybrid format
aof-use-rdb-preamble yes

# ============================================================================
# Slow Log
# ============================================================================
# Execution time threshold (microseconds)
slowlog-log-slower-than 10000

# Max entries in slow log
slowlog-max-len 128

# ============================================================================
# Latency Monitor
# ============================================================================
# Latency monitoring threshold (milliseconds, 0 = disabled)
latency-monitor-threshold 0

# ============================================================================
# Event Notification (Keyspace notifications)
# ============================================================================
# Disabled by default (can impact performance)
notify-keyspace-events ""

# ============================================================================
# Advanced Config
# ============================================================================
# Hash settings
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List settings
list-max-ziplist-size -2

# Set settings
set-max-intset-entries 512

# Sorted set settings
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog sparse representation
hll-sparse-max-bytes 3000

# Streams settings
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Frequency of rehashing
hz 10

# Enable active defragmentation (Valkey 9 feature)
# activedefrag yes
# active-defrag-ignore-bytes 100mb
# active-defrag-threshold-lower 10
# active-defrag-threshold-upper 100
# active-defrag-cycle-min 5
# active-defrag-cycle-max 75

# ============================================================================
# Notes
# ============================================================================
# - Password is set via docker-compose command: --requirepass ${VALKEY_PASSWORD}
# - Database 0: Used for sessions (configured in moodle-config.php)
# - Database 1: Recommended for MUC application cache
# - Adjust maxmemory based on available RAM (recommend 512MB-2GB)
# - For production, consider enabling active defragmentation
